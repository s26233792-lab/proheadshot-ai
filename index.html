<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProHeadshot AI - 美式专业证件照</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f7;
            background-image:
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(99, 102, 241, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: #1d1d1f;
        }

        .apple-card {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 20px 25px -5px rgba(0, 0, 0, 0.02);
            border-radius: 1.5rem;
        }

        .upload-area {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='round'/%3e%3c/svg%3e");
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .upload-area:hover {
            transform: scale(1.01);
            background-color: rgba(255, 255, 255, 0.8);
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='24' ry='24' stroke='%233B82F6FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='round'/%3e%3c/svg%3e");
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            background-color: rgba(255, 255, 255, 0.5);
        }
        .option-btn:hover {
            background-color: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }
        .option-btn.active {
            background-color: #ffffff;
            border-color: rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            color: #007aff;
        }
        .option-btn.active .icon-box { background-color: #007aff; color: white; }
        .option-btn .icon-box { transition: all 0.2s; }

        .color-swatch { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active-color { transform: scale(1.15); box-shadow: 0 0 0 3px #fff, 0 0 0 5px #007aff; }

        .progress-bar-apple {
            background: #007aff;
            background-image: linear-gradient(to right, #007aff 0%, #00c6ff 50%, #007aff 100%);
            background-size: 50% 100%;
            animation: shimmer 1.5s infinite linear;
        }
        @keyframes shimmer { 0% { background-position: 150% 0; } 100% { background-position: -50% 0; } }

        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Tab Styles */
        .tab-btn {
            @apply px-4 py-2 text-sm font-medium text-slate-500 border-b-2 border-transparent transition-all;
        }
        .tab-btn.active {
            @apply text-blue-600 border-blue-600;
        }
        .tab-btn:hover:not(.active) {
            @apply text-slate-700 hover:bg-slate-50 rounded-t-lg;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #e5e7eb;
            border-bottom-color: #3b82f6;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="selection:bg-blue-100 selection:text-blue-900">

    <!-- 顶部导航 -->
    <nav class="fixed top-0 w-full z-50 transition-all duration-300 bg-white/70 backdrop-blur-xl border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-14 items-center">
                <div class="flex items-center gap-2 group cursor-default">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-white shadow-md group-hover:rotate-12 transition-transform duration-300">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                    <span class="font-bold text-lg tracking-tight">ProHeadshot</span>
                </div>
                <div class="flex items-center gap-3">
                     <button onclick="tryOpenSettings()" class="w-8 h-8 rounded-full hover:bg-black/5 flex items-center justify-center transition-colors text-slate-500" title="设置">
                        <i class="fa-solid fa-sliders"></i>
                     </button>
                     <div class="bg-black/5 px-3 py-1.5 rounded-full flex items-center gap-2 text-xs font-semibold text-slate-600 cursor-pointer hover:bg-black/10 transition-colors" onclick="openCreditModal()">
                        <i class="fa-solid fa-bolt text-amber-500"></i>
                        <span><span id="credit-count-nav">0</span> 点数</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主界面 -->
    <main class="pt-20 pb-12 px-4 sm:px-6">
        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- 左侧：设置面板 -->
            <div class="lg:col-span-4 space-y-6 fade-in-up" style="animation-delay: 0.1s;">
                <!-- 1. 上传 -->
                <div class="apple-card p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-bold text-slate-900">照片上传</h2>
                        <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">Step 1</span>
                    </div>
                    <div class="bg-slate-100/50 p-1 rounded-xl flex gap-1 mb-4">
                        <button class="size-btn option-btn active flex-1 py-2 rounded-lg text-xs font-medium text-center relative overflow-hidden" onclick="selectSize(this, 1)">
                            <span>1:1</span><span class="block text-[10px] opacity-60">护照/签证</span>
                        </button>
                        <button class="size-btn option-btn flex-1 py-2 rounded-lg text-xs font-medium text-center" onclick="selectSize(this, 0.75)">
                            <span>3:4</span><span class="block text-[10px] opacity-60">标准2寸</span>
                        </button>
                        <button class="size-btn option-btn flex-1 py-2 rounded-lg text-xs font-medium text-center" onclick="selectSize(this, 0.714)">
                            <span>5:7</span><span class="block text-[10px] opacity-60">标准1寸</span>
                        </button>
                    </div>
                    <div class="w-full flex justify-center">
                        <div class="upload-wrapper w-full" id="upload-wrapper" style="aspect-ratio: 1/1;">
                            <div id="drop-zone" class="upload-area w-full h-full rounded-3xl flex flex-col items-center justify-center cursor-pointer relative overflow-hidden group">
                                <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" accept="image/*">
                                <div id="upload-placeholder" class="text-center p-4 transition-transform duration-300 group-hover:scale-105">
                                    <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 text-blue-500">
                                        <i class="fa-solid fa-plus text-xl"></i>
                                    </div>
                                    <p class="text-xs font-bold text-slate-700">点击上传</p>
                                    <p class="text-[10px] text-slate-400 mt-1">自动人像居中裁剪</p>
                                </div>
                                <img id="preview-upload" class="hidden absolute inset-0 w-full h-full object-cover z-10 rounded-3xl" alt="Preview">
                                <button id="remove-image" class="hidden absolute top-2 right-2 bg-white/80 backdrop-blur-md p-2 rounded-full text-slate-500 hover:text-red-500 hover:bg-white shadow-sm z-30 transition-all">
                                    <i class="fa-solid fa-xmark text-sm w-4 h-4 flex items-center justify-center"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. 定制 -->
                <div class="apple-card p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-bold text-slate-900">风格定制</h2>
                        <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full font-medium">Step 2</span>
                    </div>

                    <div class="space-y-4">
                        <!-- 拍摄角度 -->
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-wider">拍摄角度</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="angle-btn option-btn active py-2.5 px-3 rounded-xl flex items-center gap-2" onclick="selectOption('angle', this, 'Front Facing, looking directly at camera, symmetrical composition')">
                                    <div class="icon-box w-6 h-6 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center text-xs"><i class="fa-regular fa-id-badge"></i></div>
                                    <span class="text-xs font-semibold">正面对视</span>
                                </button>
                                <button class="angle-btn option-btn py-2.5 px-3 rounded-xl flex items-center gap-2" onclick="selectOption('angle', this, 'Slightly Angled Body (3/4 turn), face looking at camera, dynamic composition')">
                                    <div class="icon-box w-6 h-6 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center text-xs"><i class="fa-solid fa-user-tag"></i></div>
                                    <span class="text-xs font-semibold">微侧展示</span>
                                </button>
                            </div>
                        </div>

                        <!-- 面部质感 -->
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-wider">面部质感</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="retouch-btn option-btn active py-2.5 px-3 rounded-xl flex items-center gap-2" onclick="selectOption('retouch', this, 'beautify')">
                                    <div class="icon-box w-6 h-6 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center text-xs"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                                    <span class="text-xs font-semibold">精致美颜</span>
                                </button>
                                <button class="retouch-btn option-btn py-2.5 px-3 rounded-xl flex items-center gap-2" onclick="selectOption('retouch', this, 'original')">
                                    <div class="icon-box w-6 h-6 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center text-xs"><i class="fa-solid fa-camera"></i></div>
                                    <span class="text-xs font-semibold">保留真实</span>
                                </button>
                            </div>
                            <p id="retouch-desc" class="text-[10px] text-slate-400 mt-1.5 ml-1">深度磨皮美白，打造完美商业感。</p>
                        </div>

                        <!-- 智能换装 -->
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-wider">智能换装</label>
                            <div class="space-y-2">
                                <button class="clothing-btn option-btn active w-full p-2 rounded-xl flex items-center gap-3" onclick="selectOption('clothing', this, 'Business Formal')">
                                    <div class="icon-box w-8 h-8 rounded-lg bg-slate-100 text-slate-500 flex items-center justify-center text-sm"><i class="fa-solid fa-user-tie"></i></div>
                                    <div class="text-left"><div class="text-xs font-bold">商务正装</div><div class="text-[10px] text-slate-400">高端西装 / 职业套装</div></div>
                                </button>
                                <button class="clothing-btn option-btn w-full p-2 rounded-xl flex items-center gap-3" onclick="selectOption('clothing', this, 'Academic Doctoral Regalia')">
                                    <div class="icon-box w-8 h-8 rounded-lg bg-slate-100 text-slate-500 flex items-center justify-center text-sm"><i class="fa-solid fa-graduation-cap"></i></div>
                                    <div class="text-left"><div class="text-xs font-bold">美式博士</div><div class="text-[10px] text-slate-400">PhD 礼袍 / 绒面垂布</div></div>
                                </button>
                                <button class="clothing-btn option-btn w-full p-2 rounded-xl flex items-center gap-3" onclick="selectOption('clothing', this, 'Keep Original')">
                                    <div class="icon-box w-8 h-8 rounded-lg bg-slate-100 text-slate-500 flex items-center justify-center text-sm"><i class="fa-solid fa-shirt"></i></div>
                                    <div class="text-left"><div class="text-xs font-bold">保持原样</div><div class="text-[10px] text-slate-400">仅优化光影，不换装</div></div>
                                </button>
                            </div>
                        </div>

                        <!-- 背景色调 -->
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-wider">背景色调</label>
                            <div class="flex justify-between bg-slate-100/50 p-2 rounded-2xl">
                                <div class="color-swatch w-8 h-8 rounded-full cursor-pointer bg-white shadow-sm border border-slate-200 active-color" onclick="selectColor(this, 'Studio White')" title="纯净白"></div>
                                <div class="color-swatch w-8 h-8 rounded-full cursor-pointer bg-gray-100 shadow-sm border border-slate-200" onclick="selectColor(this, 'Classic Grey')" title="经典灰"></div>
                                <div class="color-swatch w-8 h-8 rounded-full cursor-pointer bg-[#1e3a8a] shadow-sm border border-slate-200" onclick="selectColor(this, 'Deep Navy Blue')" title="海军蓝"></div>
                                <div class="color-swatch w-8 h-8 rounded-full cursor-pointer bg-[#fef3c7] shadow-sm border border-slate-200" onclick="selectColor(this, 'Professional Warm Tone')" title="暖色调"></div>
                            </div>
                            <input type="hidden" id="selected-color" value="Studio White">
                            <p id="color-name" class="text-[10px] text-center text-slate-400 mt-1">当前: 纯净白</p>
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t border-slate-100">
                        <button id="generate-btn" class="w-full bg-gradient-to-r from-slate-900 to-slate-800 hover:from-blue-600 hover:to-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-slate-200 hover:shadow-blue-200 transition-all flex items-center justify-center gap-2 transform active:scale-[0.98] group">
                            <span>生成证件照</span>
                            <i class="fa-solid fa-wand-magic-sparkles group-hover:animate-pulse"></i>
                        </button>
                        <p id="status-msg" class="text-[10px] text-center mt-2 h-4 text-slate-400"></p>
                    </div>
                </div>
            </div>

            <!-- 右侧：预览区 -->
            <div class="lg:col-span-8 fade-in-up" style="animation-delay: 0.2s;">
                <div class="apple-card p-1.5 h-full min-h-[600px] flex flex-col relative">
                    <div class="absolute top-5 left-6 right-6 flex justify-between items-center z-10 pointer-events-none">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest bg-white/80 backdrop-blur px-3 py-1 rounded-full shadow-sm">预览结果</h3>
                        <div class="flex gap-2 pointer-events-auto">
                            <button onclick="toggleDebug()" class="text-[10px] text-slate-400 bg-white/80 backdrop-blur px-3 py-1.5 rounded-full hover:bg-white hover:text-slate-600 shadow-sm transition">DEBUG</button>
                            <button id="download-btn" disabled class="bg-white/80 backdrop-blur text-slate-300 px-4 py-1.5 rounded-full text-xs font-bold shadow-sm transition-all flex items-center gap-2 hover:bg-white hover:text-blue-600 hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-download"></i> 下载
                            </button>
                        </div>
                    </div>
                    <div class="flex-grow bg-slate-50/50 rounded-[22px] border border-slate-100 relative overflow-hidden flex items-center justify-center">
                        <div id="result-container" class="transition-all duration-500 ease-out p-8 flex items-center justify-center w-full h-full" style="aspect-ratio: 1/1; max-height: 700px;">
                            <div id="result-placeholder" class="text-center space-y-4">
                                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto shadow-sm border border-slate-50"><i class="fa-regular fa-image text-3xl text-slate-300"></i></div>
                                <div><p class="text-sm font-medium text-slate-500">暂无生成结果</p><p class="text-xs text-slate-400 mt-1">请上传照片并点击生成</p></div>
                            </div>
                            <div id="loading-state" class="hidden absolute inset-0 bg-white/80 backdrop-blur-md z-20 flex flex-col items-center justify-center p-8">
                                <div class="w-64 text-center space-y-6">
                                    <div class="loader mx-auto"></div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-xs font-bold text-slate-600 px-1"><span id="loading-text">AI 正在处理...</span><span id="percent-text">0%</span></div>
                                        <div class="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden"><div id="progress-bar" class="h-full w-0 progress-bar-apple rounded-full"></div></div>
                                    </div>
                                    <p id="loading-tip" class="text-xs text-slate-400 animate-pulse font-medium">正在分析面部光影...</p>
                                </div>
                            </div>
                            <img id="result-image" class="hidden w-full h-full object-contain shadow-2xl rounded-lg z-30 relative" alt="Result">
                        </div>
                        <div id="debug-panel" class="hidden absolute bottom-4 left-4 right-4 bg-slate-900/95 backdrop-blur text-green-400 p-4 rounded-xl text-[10px] font-mono h-48 overflow-y-auto border border-white/10 z-50 shadow-2xl">
                            <div class="flex justify-between border-b border-white/10 pb-2 mb-2 sticky top-0 bg-transparent"><span>DEBUG LOG</span><div class="flex gap-2"><button onclick="clearDebug()" class="text-slate-400 hover:text-white">CLEAR</button><button onclick="toggleDebug()" class="text-red-400 hover:text-red-300">CLOSE</button></div></div>
                            <div id="debug-content" class="whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center apple-card">
            <h3 class="text-lg font-bold mb-4">管理员验证</h3>
            <input type="password" id="admin-password-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-center mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="输入密码">
            <button onclick="verifyAdminPassword()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold mb-2">登录</button>
            <button onclick="closeModal('admin-login-modal')" class="text-xs text-slate-400">取消</button>
        </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl p-6 apple-card h-[600px] flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-gauge-high text-blue-600"></i> 管理员仪表盘</h3>
                <button onclick="closeModal('settings-modal')"><i class="fa-solid fa-xmark text-slate-400 hover:text-slate-600"></i></button>
            </div>

            <!-- Tabs -->
            <div class="flex gap-6 mb-4 border-b border-slate-100" id="tab-buttons">
                <button class="tab-btn active" data-tab="api-config" onclick="switchTab('api-config')">API 配置</button>
                <button class="tab-btn" data-tab="code-manage" onclick="switchTab('code-manage')">卡密管理</button>
            </div>

            <div class="flex-1 overflow-y-auto pr-2">
                <!-- API Config -->
                <div id="tab-api-config" class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 block mb-1">API Base URL</label>
                        <input type="text" id="api-base-url-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono" value="https://new.12ai.org/v1" oninput="updateUrlPreview()">
                        <div class="flex items-center gap-2 mt-2">
                            <input type="checkbox" id="auto-clean-path" class="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500" checked onchange="updateUrlPreview()">
                            <label for="auto-clean-path" class="text-[11px] text-slate-500 font-medium cursor-pointer select-none">自动优化路径 (移除 /v1, /v1beta)</label>
                        </div>
                    </div>
                    <div><label class="text-xs font-bold text-slate-500 block mb-1">API Key</label><input type="password" id="api-key-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono" value=""></div>
                    <div><label class="text-xs font-bold text-slate-500 block mb-1">Model ID</label><input type="text" id="api-model-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-mono" value="gemini-2.0-flash-exp" oninput="updateUrlPreview()"></div>
                    <div class="bg-slate-50 p-2 rounded-lg"><code id="url-preview" class="text-[10px] text-blue-600 break-all block"></code></div>

                    <div class="flex gap-2 mt-4">
                        <button id="test-btn" onclick="testConnection()" class="flex-1 border border-slate-200 py-2.5 rounded-xl text-xs font-bold hover:bg-slate-50">测试连接</button>
                        <button onclick="saveSettings()" class="flex-1 bg-blue-600 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-blue-700">保存设置</button>
                    </div>
                    <p id="test-status" class="text-xs text-center h-4 mt-2"></p>
                </div>

                <!-- Code Management -->
                <div id="tab-code-manage" class="hidden space-y-4">
                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                        <h4 class="text-xs font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-ticket text-blue-500"></i> 批量生成卡密
                        </h4>

                        <!-- Points Selection -->
                        <div class="mb-4">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">单张卡密包含次数 (点数)</label>
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button onclick="setCodePoints(1)" class="px-3 py-1.5 bg-white border border-slate-200 text-xs font-medium rounded-lg hover:border-blue-500 hover:text-blue-600 hover:shadow-sm transition active:scale-95">1次</button>
                                <button onclick="setCodePoints(5)" class="px-3 py-1.5 bg-white border border-slate-200 text-xs font-medium rounded-lg hover:border-blue-500 hover:text-blue-600 hover:shadow-sm transition active:scale-95">5次</button>
                                <button onclick="setCodePoints(10)" class="px-3 py-1.5 bg-white border border-slate-200 text-xs font-medium rounded-lg hover:border-blue-500 hover:text-blue-600 hover:shadow-sm transition active:scale-95">10次</button>
                                <button onclick="setCodePoints(50)" class="px-3 py-1.5 bg-white border border-slate-200 text-xs font-medium rounded-lg hover:border-blue-500 hover:text-blue-600 hover:shadow-sm transition active:scale-95">50次</button>
                                <button onclick="setCodePoints(100)" class="px-3 py-1.5 bg-white border border-slate-200 text-xs font-medium rounded-lg hover:border-blue-500 hover:text-blue-600 hover:shadow-sm transition active:scale-95">100次</button>
                            </div>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa-solid fa-star text-slate-300 text-xs"></i>
                                </div>
                                <input type="number" id="code-points" class="w-full py-2.5 pl-8 pr-8 text-xs border border-slate-200 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" value="10" placeholder="自定义点数">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-xs text-slate-400 font-medium">次</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quantity Selection -->
                        <div class="mb-5">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">生成张数</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa-solid fa-layer-group text-slate-300 text-xs"></i>
                                </div>
                                <input type="number" id="code-amount" class="w-full py-2.5 pl-8 pr-8 text-xs border border-slate-200 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" value="1" min="1" max="100">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-xs text-slate-400 font-medium">张</span>
                                </div>
                            </div>
                        </div>

                        <button onclick="generateCodes()" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-xl text-xs font-bold shadow-lg shadow-slate-200 active:scale-[0.98] transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus-circle"></i> 生成并保存卡密
                        </button>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-3 px-1">
                            <h4 class="text-xs font-bold text-slate-700 flex items-center gap-2">
                                <i class="fa-solid fa-list-ul text-slate-400"></i> 有效卡密列表 (<span id="code-total-count">0</span>)
                            </h4>
                            <div class="flex gap-3">
                                <button onclick="exportCodes()" class="text-[10px] text-blue-600 font-bold hover:text-blue-700 hover:bg-blue-50 px-2 py-1 rounded transition"><i class="fa-solid fa-file-export mr-1"></i>导出TXT</button>
                                <button onclick="clearAllCodes()" class="text-[10px] text-red-500 font-bold hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded transition"><i class="fa-solid fa-trash mr-1"></i>清空所有</button>
                            </div>
                        </div>
                        <div class="h-48 overflow-y-auto border border-slate-100 rounded-2xl bg-white text-xs shadow-sm">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 sticky top-0 text-[10px] text-slate-500 z-10">
                                    <tr><th class="p-3 font-bold border-b border-slate-100">卡密 (点击复制)</th><th class="p-3 font-bold border-b border-slate-100">点数</th><th class="p-3 font-bold border-b border-slate-100">状态</th></tr>
                                </thead>
                                <tbody id="code-list-body" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Modal -->
    <div id="credit-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-8 text-center apple-card">
            <div class="w-16 h-16 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-ticket"></i></div>
            <h3 class="font-bold text-lg mb-4">卡密充值</h3>
            <input type="text" id="verify-code-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-center mb-4 uppercase font-mono tracking-wider" placeholder="输入卡密...">
            <button onclick="verifyCode()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold mb-2 shadow-lg shadow-amber-100 transition hover:bg-amber-600 active:scale-95">立即激活</button>
            <button onclick="closeModal('credit-modal')" class="text-xs text-slate-400 hover:text-slate-600">取消</button>
        </div>
    </div>

    <script>
        // ==================== 配置 ====================
        const config = {
            apiKey: "",
            userKey: "",
            baseUrl: "https://new.12ai.org/v1",
            modelId: "gemini-2.0-flash-exp",
            autoCleanPath: true,
            adminPwd: "admin888",
            isAdmin: false,
            credits: 0,
            isGenerating: false,
            currentRatio: 1,
            originalFile: null,
            imageBase64: null,
            selectedRetouch: 'beautify',
            selectedClothing: 'Business Formal',
            selectedAngle: 'Front Facing',
            abortController: null
        };

        // ==================== 元素选择器 ====================
        const els = {
            fileInput: document.getElementById('file-input'),
            preview: document.getElementById('preview-upload'),
            uploadPlace: document.getElementById('upload-placeholder'),
            removeBtn: document.getElementById('remove-image'),
            wrapper: document.getElementById('upload-wrapper'),
            genBtn: document.getElementById('generate-btn'),
            loading: document.getElementById('loading-state'),
            progressBar: document.getElementById('progress-bar'),
            loadingText: document.getElementById('loading-text'),
            percentText: document.getElementById('percent-text'),
            resultImg: document.getElementById('result-image'),
            resultBox: document.getElementById('result-container'),
            resultPlace: document.getElementById('result-placeholder'),
            downloadBtn: document.getElementById('download-btn'),
            creditNav: document.getElementById('credit-count-nav'),
            urlPreview: document.getElementById('url-preview'),
            testStatus: document.getElementById('test-status'),
            statusMsg: document.getElementById('status-msg'),
            retouchDesc: document.getElementById('retouch-desc'),
            debugPanel: document.getElementById('debug-panel'),
            debugContent: document.getElementById('debug-content'),
            autoCleanCheck: document.getElementById('auto-clean-path'),
            codeListBody: document.getElementById('code-list-body'),
            codeTotalCount: document.getElementById('code-total-count')
        };

        const tips = ["正在构建3D面部...", "优化伦勃朗光影...", "适配博士服材质...", "正在生成 2K 原图..."];

        // ==================== 卡密管理系统 ====================
        const CodeManager = {
            // 获取存储键名（可加前缀区分不同环境）
            getKey: () => 'proheadshot_codes_db',

            // 获取所有卡密
            getAll: () => {
                try {
                    const data = localStorage.getItem(CodeManager.getKey());
                    return data ? JSON.parse(data) : {};
                } catch (e) {
                    console.error('读取卡密数据失败:', e);
                    return {};
                }
            },

            // 保存卡密数据
            save: (codes) => {
                try {
                    localStorage.setItem(CodeManager.getKey(), JSON.stringify(codes));
                    return true;
                } catch (e) {
                    console.error('保存卡密数据失败:', e);
                    alert('存储空间不足，请清理浏览器缓存');
                    return false;
                }
            },

            // 生成卡密
            generate: (points, amount) => {
                const codes = CodeManager.getAll();
                let generated = [];

                for (let i = 0; i < amount; i++) {
                    // 生成格式: SK-XXXX-XXXX
                    const code = 'SK-' + Math.random().toString(36).substr(2, 4).toUpperCase() + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
                    codes[code] = {
                        points: parseInt(points),
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                    generated.push(code);
                }

                if (CodeManager.save(codes)) {
                    return generated;
                }
                return [];
            },

            // 验证并兑换卡密
            redeem: (code) => {
                if (!code || typeof code !== 'string') return 0;

                const cleanCode = code.trim().toUpperCase();
                const codes = CodeManager.getAll();

                // 检查卡密是否存在
                if (codes[cleanCode]) {
                    const codeData = codes[cleanCode];

                    // 检查状态
                    if (codeData.status !== 'active') {
                        return 0; // 已使用或无效
                    }

                    const points = codeData.points;

                    // 标记为已使用
                    codes[cleanCode].status = 'used';
                    codes[cleanCode].usedAt = new Date().toISOString();

                    CodeManager.save(codes);
                    return points;
                }

                return 0; // 无效卡密
            },

            // 检查卡密状态（不消费）
            checkStatus: (code) => {
                const cleanCode = code.trim().toUpperCase();
                const codes = CodeManager.getAll();
                return codes[cleanCode] ? codes[cleanCode].status : null;
            },

            // 清空所有卡密
            clearAll: () => {
                localStorage.removeItem(CodeManager.getKey());
            },

            // 获取统计信息
            getStats: () => {
                const codes = CodeManager.getAll();
                const values = Object.values(codes);
                return {
                    total: values.length,
                    active: values.filter(c => c.status === 'active').length,
                    used: values.filter(c => c.status === 'used').length,
                    totalPoints: values.reduce((sum, c) => sum + (c.status === 'active' ? c.points : 0), 0)
                };
            }
        };

        // ==================== 用户积分系统 ====================
        const CreditManager = {
            getKey: () => 'proheadshot_user_credits',

            // 获取用户积分
            get: () => {
                try {
                    return parseInt(localStorage.getItem(CreditManager.getKey()) || '0');
                } catch (e) {
                    return 0;
                }
            },

            // 设置积分
            set: (credits) => {
                try {
                    localStorage.setItem(CreditManager.getKey(), credits.toString());
                    config.credits = credits;
                    updateCreditDisplay();
                    return true;
                } catch (e) {
                    return false;
                }
            },

            // 增加积分
            add: (points) => {
                const current = CreditManager.get();
                return CreditManager.set(current + points);
            },

            // 扣除积分
            deduct: (points) => {
                const current = CreditManager.get();
                if (current >= points) {
                    return CreditManager.set(current - points);
                }
                return false;
            }
        };

        // ==================== API 管理 ====================
        const APIManager = {
            // 构建完整 URL
            getUrl: (overrideBaseUrl, overrideModel, overrideKey) => {
                let base = (overrideBaseUrl || config.baseUrl).replace(/\/+$/, '');
                const model = overrideModel || config.modelId;
                const key = overrideKey || config.userKey || config.apiKey;

                if (config.autoCleanPath) {
                    // 移除 /v1 或 /v1beta 结尾
                    base = base.replace(/\/v1beta$|\/v1$/, '');
                    return `${base}/v1beta/models/${model}:generateContent?key=${key}`;
                }

                return `${base}/models/${model}:generateContent?key=${key}`;
            },

            // 测试连接
            test: async () => {
                const url = APIManager.getUrl();
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "ping" }] }]
                        })
                    });

                    if (response.ok) {
                        return { success: true, message: '连接成功' };
                    } else {
                        const data = await response.json().catch(() => ({}));
                        return { success: false, message: `HTTP ${response.status}`, error: data };
                    }
                } catch (error) {
                    return { success: false, message: error.message };
                }
            },

            // 生成图片
            generateImage: async (imageBase64, prompt, signal) => {
                const url = APIManager.getUrl();

                // 构建请求体
                const requestBody = {
                    contents: [
                        {
                            parts: [
                                {
                                    inlineData: {
                                        mimeType: "image/jpeg",
                                        data: imageBase64.split(',')[1]
                                    }
                                },
                                {
                                    text: prompt
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseModalities: ["IMAGE", "TEXT"]
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: signal
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: { message: '未知错误' } }));
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();

                // 提取图片数据
                const imagePart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                if (imagePart?.inlineData?.data) {
                    return `data:image/jpeg;base64,${imagePart.inlineData.data}`;
                }

                throw new Error('未收到图片数据');
            }
        };

        // ==================== 工具函数 ====================
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg}\n`;
            console.log(line);
            els.debugContent.textContent += line;
            if (type === 'error') toggleDebug(true);
        }

        function toggleDebug(force) {
            if (force === true) {
                els.debugPanel.classList.remove('hidden');
            } else if (force === false) {
                els.debugPanel.classList.add('hidden');
            } else {
                els.debugPanel.classList.toggle('hidden');
            }
        }

        function clearDebug() {
            els.debugContent.textContent = '';
        }

        function showStatus(msg, type = 'normal') {
            els.statusMsg.textContent = msg;
            els.statusMsg.className = 'text-[10px] text-center mt-2 h-4';
            if (type === 'error') els.statusMsg.classList.add('text-red-500');
            else if (type === 'success') els.statusMsg.classList.add('text-green-600');
            else els.statusMsg.classList.add('text-slate-400');
        }

        function updateCreditDisplay() {
            els.creditNav.textContent = config.credits;
            if (!config.isGenerating) {
                if (config.credits <= 0) {
                    els.genBtn.innerHTML = `<span>获取生成次数</span> <i class="fa-solid fa-key ml-2"></i>`;
                    els.genBtn.className = "w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-xl transition-all flex items-center justify-center";
                } else {
                    els.genBtn.innerHTML = `<span>生成证件照</span> <i class="fa-solid fa-wand-magic-sparkles ml-2"></i>`;
                    els.genBtn.className = "w-full bg-slate-900 hover:bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all flex items-center justify-center active:scale-[0.98]";
                }
            }
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function resetUI() {
            config.isGenerating = false;
            els.loading.classList.add('hidden');
            els.genBtn.innerHTML = `<span>生成证件照</span> <i class="fa-solid fa-wand-magic-sparkles ml-2"></i>`;
            els.genBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        }

        // ==================== 图片处理 ====================
        async function handleFileUpload(file) {
            if (!file || !file.type.startsWith('image/')) return;
            config.originalFile = file;
            showStatus("正在裁剪图片...", "info");

            try {
                config.imageBase64 = await resizeAndCrop(file, config.currentRatio);
                els.preview.src = config.imageBase64;
                els.preview.classList.remove('hidden');
                els.uploadPlace.classList.add('hidden');
                els.removeBtn.classList.remove('hidden');
                els.fileInput.value = '';
                showStatus("", "normal");
            } catch (e) {
                showStatus("图片处理失败", "error");
                log(e, 'error');
            }
        }

        function resizeAndCrop(file, ratio) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            const cvs = document.createElement('canvas');
                            let sw = img.width, sh = img.height, sx = 0, sy = 0;

                            // 计算裁剪区域（人像居中，稍微偏上）
                            if (sw / sh > ratio) {
                                let nw = sh * ratio;
                                sx = (sw - nw) / 2;
                                sw = nw;
                            } else {
                                let nh = sw / ratio;
                                sy = (sh - nh) * 0.15; // 稍微偏上，保留更多头部
                                sh = nh;
                            }

                            const size = 1536; // 高分辨率输入
                            cvs.width = size;
                            cvs.height = size / ratio;

                            const ctx = cvs.getContext('2d');
                            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, cvs.width, cvs.height);

                            resolve(cvs.toDataURL('image/jpeg', 0.95));
                        } catch (err) {
                            reject(err);
                        }
                    };
                    img.onerror = () => reject(new Error('图片加载失败'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('文件读取失败'));
                reader.readAsDataURL(file);
            });
        }

        // ==================== UI 交互 ====================
        function selectSize(btn, ratio) {
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            config.currentRatio = ratio;
            els.wrapper.style.aspectRatio = `${ratio}/1`;
            els.resultBox.style.aspectRatio = `${ratio}/1`;
            if (config.originalFile) handleFileUpload(config.originalFile);
        }

        function selectOption(type, btn, val) {
            if (type === 'angle') {
                document.querySelectorAll('.angle-btn').forEach(b => b.classList.remove('active'));
                config.selectedAngle = val;
            }
            if (type === 'retouch') {
                document.querySelectorAll('.retouch-btn').forEach(b => b.classList.remove('active'));
                config.selectedRetouch = val;
                els.retouchDesc.textContent = val === 'beautify'
                    ? "深度磨皮美白，去除瑕疵，提亮眼神，打造完美无瑕的商业精修感。"
                    : "保留真实皮肤纹理和特征（如痣），仅做极轻微的光影优化，还原真实自我。";
            }
            if (type === 'clothing') {
                document.querySelectorAll('.clothing-btn').forEach(b => b.classList.remove('active'));
                config.selectedClothing = val;
            }
            btn.classList.add('active');
        }

        function selectColor(div, val) {
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active-color'));
            div.classList.add('active-color');
            document.getElementById('selected-color').value = val;
            const names = {
                'Studio White': '纯净白',
                'Classic Grey': '经典灰',
                'Deep Navy Blue': '海军蓝',
                'Professional Warm Tone': '暖色调'
            };
            document.getElementById('color-name').textContent = "当前: " + (names[val] || val);
        }

        // ==================== 设置/管理员 ====================
        function tryOpenSettings() {
            if (config.isAdmin) {
                openModal('settings-modal');
                updateUrlPreview();
            } else {
                openModal('admin-login-modal');
            }
        }

        function verifyAdminPassword() {
            const pwd = document.getElementById('admin-password-input').value;
            if (pwd === config.adminPwd) {
                config.isAdmin = true;
                closeModal('admin-login-modal');
                openModal('settings-modal');
                updateUrlPreview();
                renderCodeList();
                switchTab('api-config');
            } else {
                alert("密码错误");
            }
        }

        function switchTab(tabId) {
            // 更新按钮状态
            document.querySelectorAll('#tab-buttons .tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabId) btn.classList.add('active');
            });

            // 切换内容
            document.getElementById('tab-api-config').classList.add('hidden');
            document.getElementById('tab-code-manage').classList.add('hidden');
            document.getElementById('tab-' + tabId).classList.remove('hidden');

            if (tabId === 'code-manage') {
                renderCodeList();
            }
        }

        function updateUrlPreview() {
            const baseUrl = document.getElementById('api-base-url-input')?.value || config.baseUrl;
            const model = document.getElementById('api-model-input')?.value || config.modelId;
            els.urlPreview.textContent = APIManager.getUrl(baseUrl, model, 'YOUR_KEY');
        }

        function saveSettings() {
            config.userKey = document.getElementById('api-key-input').value.trim();
            config.baseUrl = document.getElementById('api-base-url-input').value.trim();
            config.modelId = document.getElementById('api-model-input').value.trim();
            config.autoCleanPath = els.autoCleanCheck.checked;

            // 保存到 localStorage
            try {
                localStorage.setItem('proheadshot_config', JSON.stringify({
                    userKey: config.userKey,
                    baseUrl: config.baseUrl,
                    modelId: config.modelId,
                    autoCleanPath: config.autoCleanPath
                }));
            } catch (e) {}

            closeModal('settings-modal');
            showStatus("配置已保存", "success");
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('proheadshot_config');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.userKey) config.userKey = data.userKey;
                    if (data.baseUrl) config.baseUrl = data.baseUrl;
                    if (data.modelId) config.modelId = data.modelId;
                    if (typeof data.autoCleanPath === 'boolean') config.autoCleanPath = data.autoCleanPath;
                }
            } catch (e) {}
        }

        async function testConnection() {
            const btn = document.getElementById('test-btn');
            btn.disabled = true;

            // 临时使用输入框的值进行测试
            const originalConfig = { ...config };
            config.userKey = document.getElementById('api-key-input').value.trim() || config.userKey;
            config.baseUrl = document.getElementById('api-base-url-input').value.trim();
            config.modelId = document.getElementById('api-model-input').value.trim();

            els.testStatus.textContent = "正在测试...";
            els.testStatus.className = "text-xs text-center text-slate-400";

            const result = await APIManager.test();

            if (result.success) {
                els.testStatus.textContent = "✅ 连接成功";
                els.testStatus.className = "text-xs text-center text-green-500 font-bold";
            } else {
                els.testStatus.textContent = `❌ 失败: ${result.message}`;
                els.testStatus.className = "text-xs text-center text-red-500 font-bold";
            }

            // 恢复配置
            Object.assign(config, originalConfig);
            btn.disabled = false;
        }

        // ==================== 卡密管理 ====================
        function setCodePoints(val) {
            document.getElementById('code-points').value = val;
        }

        function generateCodes() {
            const pts = parseInt(document.getElementById('code-points').value) || 10;
            const amt = parseInt(document.getElementById('code-amount').value) || 1;

            if (amt < 1 || amt > 100) {
                alert('生成数量请在 1-100 之间');
                return;
            }

            const generated = CodeManager.generate(pts, amt);
            if (generated.length > 0) {
                renderCodeList();
                showStatus(`已生成 ${amt} 张卡密`, "success");
            } else {
                alert('生成失败，可能是存储空间不足');
            }
        }

        function renderCodeList() {
            const codes = CodeManager.getAll();
            const keys = Object.keys(codes).reverse();
            els.codeTotalCount.textContent = keys.length;

            if (keys.length === 0) {
                els.codeListBody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-300 italic">暂无可用卡密，请在上方生成</td></tr>';
                return;
            }

            let html = keys.map(k => {
                const c = codes[k];
                const statusClass = c.status === 'active'
                    ? 'text-emerald-600 bg-emerald-50 border-emerald-100'
                    : 'text-slate-400 bg-slate-50 border-slate-100';
                const statusText = c.status === 'active' ? 'ACTIVE' : 'USED';

                return `
                    <tr class="hover:bg-slate-50 cursor-pointer transition-colors" onclick="navigator.clipboard.writeText('${k}');showStatus('已复制: ${k}', 'success')">
                        <td class="p-3 font-mono text-slate-600 tracking-wide text-[11px]">${k}</td>
                        <td class="p-3 font-bold"><span class="bg-blue-50 px-2 py-0.5 rounded text-blue-700 text-[11px]">${c.points} 次</span></td>
                        <td class="p-3"><span class="text-[10px] font-bold px-2 py-0.5 rounded-full border ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');

            els.codeListBody.innerHTML = html;
        }

        function exportCodes() {
            const codes = CodeManager.getAll();
            const keys = Object.keys(codes);
            if (keys.length === 0) {
                alert('暂无数据可导出');
                return;
            }

            // 只导出有效卡密
            const activeCodes = keys.filter(k => codes[k].status === 'active');
            if (activeCodes.length === 0) {
                alert('没有有效卡密可导出');
                return;
            }

            const txt = activeCodes.map(k => `${k}  |  ${codes[k].points}次`).join('\n');
            const blob = new Blob([txt], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `proheadshot_codes_${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showStatus(`已导出 ${activeCodes.length} 张卡密`, "success");
        }

        function clearAllCodes() {
            if (confirm("警告：确定清空所有未使用的卡密吗？此操作不可恢复！")) {
                CodeManager.clearAll();
                renderCodeList();
                showStatus("卡密库已清空", "success");
            }
        }

        // ==================== 充值 ====================
        function verifyCode() {
            const input = document.getElementById('verify-code-input');
            const code = input.value.trim();

            if (!code) {
                alert('请输入卡密');
                return;
            }

            const points = CodeManager.redeem(code);

            if (points > 0) {
                CreditManager.add(points);
                closeModal('credit-modal');
                showStatus(`充值成功 +${points} 点数`, "success");
                input.value = '';
            } else {
                alert('无效或已使用的卡密');
            }
        }

        // ==================== 生成图片 ====================
        els.genBtn.addEventListener('click', async () => {
            if (config.isGenerating) {
                if (confirm('取消生成？')) {
                    if (config.abortController) config.abortController.abort();
                    resetUI();
                }
                return;
            }

            // 检查积分
            if (config.credits <= 0) {
                openModal('credit-modal');
                return;
            }

            // 检查图片
            if (!config.imageBase64) {
                showStatus("请先上传照片", "error");
                return;
            }

            // 检查 API 配置
            if (!config.userKey && !config.apiKey) {
                showStatus("请先配置 API Key", "error");
                tryOpenSettings();
                return;
            }

            config.isGenerating = true;
            config.abortController = new AbortController();

            els.genBtn.innerHTML = `<span>取消生成</span> <i class="fa-solid fa-stop ml-2"></i>`;
            els.genBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            els.loading.classList.remove('hidden');
            els.resultPlace.classList.add('hidden');
            els.resultImg.classList.add('hidden');

            log("开始生成任务...");

            // 进度动画
            let progress = 0;
            const progressTimer = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 3;
                    els.progressBar.style.width = `${progress}%`;
                    els.percentText.textContent = `${Math.floor(progress)}%`;
                    const tipIndex = Math.min(Math.floor(progress / 25), tips.length - 1);
                    document.getElementById('loading-tip').textContent = tips[tipIndex];
                }
            }, 300);

            try {
                // 构建提示词
                const retouchPrompt = config.selectedRetouch === 'beautify'
                    ? "RETOUCHING: Strong Beauty Filter. Flawless porcelain skin, remove blemishes, skin whitening."
                    : "RETOUCHING: Professional Natural/Realistic. High-fidelity texture, retain pores/moles. Subtle smoothing.";

                const clothingPrompt = config.selectedClothing === 'Keep Original'
                    ? "Preserve input clothing, only optimize lighting and colors."
                    : config.selectedClothing;

                const prompt = `Generate a MASTERPIECE American Corporate Headshot. STRICT IDENTITY PRESERVATION - the person's face must remain recognizably the same.
STYLE: LinkedIn/Forbes professional business portrait.
LIGHTING: Rembrandt studio lighting with subtle fill.
${retouchPrompt}
ANGLE: ${config.selectedAngle}.
CLOTHING: ${clothingPrompt}.
${config.selectedClothing === 'Academic Doctoral Regalia' ? 'PhD doctoral robe with velvet panels, NO hat/cap.' : ''}
BACKGROUND: Professional studio background, soft natural light, slightly blurred bokeh effect. Color tone: ${document.getElementById('selected-color').value}.
QUALITY: Ultra-High Resolution, sharp focus, highly detailed, photorealistic, no artifacts, 4K quality.
CRITICAL: Preserve facial features, ethnicity, and identity. Do not change the person's appearance beyond the specified styling.`;

                log(`发送请求到: ${APIManager.getUrl().split('?')[0]}/...`);

                // 调用 API
                const resultImage = await APIManager.generateImage(
                    config.imageBase64,
                    prompt,
                    config.abortController.signal
                );

                // 显示结果
                els.resultImg.src = resultImage;
                els.resultImg.classList.remove('hidden');
                els.resultPlace.classList.add('hidden');
                els.downloadBtn.disabled = false;

                // 扣除积分
                CreditManager.deduct(1);

                els.progressBar.style.width = '100%';
                els.percentText.textContent = '100%';
                document.getElementById('loading-tip').textContent = '生成完成！';

                log("生成成功");

                setTimeout(() => {
                    els.loading.classList.add('hidden');
                    resetUI();
                }, 500);

            } catch (error) {
                log(`生成失败: ${error.message}`, 'error');
                showStatus(`生成失败: ${error.message}`, "error");
                resetUI();
            } finally {
                clearInterval(progressTimer);
            }
        });

        // ==================== 下载 ====================
        els.downloadBtn.addEventListener('click', () => {
            if (els.resultImg.src) {
                const a = document.createElement('a');
                a.href = els.resultImg.src;
                a.download = `proheadshot_${Date.now()}.jpg`;
                a.click();
            }
        });

        // ==================== 事件监听 ====================
        els.fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

        els.removeBtn.addEventListener('click', () => {
            config.imageBase64 = null;
            config.originalFile = null;
            els.preview.src = '';
            els.preview.classList.add('hidden');
            els.uploadPlace.classList.remove('hidden');
            els.removeBtn.classList.add('hidden');
            els.fileInput.value = '';
        });

        // ==================== 初始化 ====================
        function init() {
            // 加载保存的配置
            loadSettings();

            // 加载用户积分
            config.credits = CreditManager.get();
            updateCreditDisplay();

            // 填充设置表单
            document.getElementById('api-base-url-input').value = config.baseUrl;
            document.getElementById('api-model-input').value = config.modelId;
            document.getElementById('api-key-input').value = config.userKey;
            els.autoCleanCheck.checked = config.autoCleanPath;

            // 更新 URL 预览
            updateUrlPreview();

            log("应用已初始化");
            log(`当前积分: ${config.credits}`);
        }

        // 启动
        init();
    </script>
</body>
</html>
