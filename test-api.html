<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f7;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #1d1d1f; margin-bottom: 20px; }
        h2 { color: #3b82f6; font-size: 18px; margin-bottom: 10px; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
        }
        .result {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.error { background: #fef2f2; color: #dc2626; }
        .result.success { background: #f0fdf4; color: #16a34a; }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .stat-box {
            background: #dbeafe;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af;
        }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>ğŸ”§ Vercel Postgres API æµ‹è¯•å·¥å…·</h1>

    <!-- æ•°æ®åº“åˆå§‹åŒ– -->
    <div class="card">
        <h2>1ï¸âƒ£ æ•°æ®åº“åˆå§‹åŒ–</h2>
        <p>é¦–æ¬¡éƒ¨ç½²åå¿…é¡»å…ˆåˆå§‹åŒ–æ•°æ®åº“</p>
        <button onclick="initDatabase()">åˆå§‹åŒ–æ•°æ®åº“</button>
        <div id="init-result" class="result" style="display:none"></div>
    </div>

    <!-- ç”ŸæˆéªŒè¯ç  -->
    <div class="card">
        <h2>2ï¸âƒ£ ç”ŸæˆéªŒè¯ç </h2>
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <label>ç‚¹æ•°:</label>
            <input type="number" id="gen-points" value="1" min="1" max="10000">
            <label>æ•°é‡:</label>
            <input type="number" id="gen-amount" value="10" min="1" max="100">
            <button onclick="generateCodes()">ç”Ÿæˆ</button>
        </div>
        <div id="gen-result" class="result" style="display:none"></div>
    </div>

    <!-- éªŒè¯éªŒè¯ç  -->
    <div class="card">
        <h2>3ï¸âƒ£ éªŒè¯éªŒè¯ç </h2>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="verify-code" placeholder="è¾“å…¥éªŒè¯ç " style="width:300px;">
            <button onclick="verifyCode()">éªŒè¯</button>
        </div>
        <div id="verify-result" class="result" style="display:none"></div>
    </div>

    <!-- ç»Ÿè®¡æ•°æ® -->
    <div class="card">
        <h2>4ï¸âƒ£ ç»Ÿè®¡æ•°æ®</h2>
        <button onclick="getStats()">è·å–ç»Ÿè®¡</button>
        <div id="stats-result" style="display:none">
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="stat-total">-</div>
                    <div class="stat-label">æ€»æ•°</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-active">-</div>
                    <div class="stat-label">å¯ç”¨</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-used">-</div>
                    <div class="stat-label">å·²ç”¨</div>
                </div>
            </div>
        </div>
        <div id="stats-detail" class="result" style="display:none"></div>
    </div>

    <!-- è·å–åˆ—è¡¨ -->
    <div class="card">
        <h2>5ï¸âƒ£ éªŒè¯ç åˆ—è¡¨</h2>
        <button onclick="getCodeList()">è·å–åˆ—è¡¨</button>
        <div id="list-result" class="result" style="display:none"></div>
    </div>

    <!-- å¯¼å‡º -->
    <div class="card">
        <h2>6ï¸âƒ£ å¯¼å‡ºæ•°æ®</h2>
        <button onclick="exportCodes()">å¯¼å‡º JSON</button>
        <div id="export-result" class="result" style="display:none"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}/api${endpoint}`;
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                return { success: true, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function showResult(elementId, result, isError = false) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = 'result' + (isError ? ' error' : ' success');
            el.textContent = typeof result === 'object' ? JSON.stringify(result, null, 2) : result;
        }

        async function initDatabase() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>åˆå§‹åŒ–ä¸­...';

            try {
                // ç›´æ¥è®¿é—®é¡µé¢ä¼šè¿”å› HTML
                window.open('/api/init-db', '_blank');
                showResult('init-result', 'è¯·åœ¨æ–°å¼€çš„æ ‡ç­¾é¡µä¸­æŸ¥çœ‹åˆå§‹åŒ–ç»“æœ');
            } catch (error) {
                showResult('init-result', error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'åˆå§‹åŒ–æ•°æ®åº“';
            }
        }

        async function generateCodes() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';

            const points = document.getElementById('gen-points').value;
            const amount = document.getElementById('gen-amount').value;

            const result = await apiRequest('/generate-codes', {
                method: 'POST',
                body: JSON.stringify({ points: parseInt(points), amount: parseInt(amount) })
            });

            if (result.success) {
                showResult('gen-result', `âœ… ${result.data.message}\n\nç”Ÿæˆçš„éªŒè¯ç :\n${result.data.codes.map(c => c.code).join(', ')}`);
            } else {
                showResult('gen-result', result.error, true);
            }

            btn.disabled = false;
            btn.innerHTML = 'ç”Ÿæˆ';
        }

        async function verifyCode() {
            const code = document.getElementById('verify-code').value.trim().toUpperCase();
            if (!code) {
                alert('è¯·è¾“å…¥éªŒè¯ç ');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>éªŒè¯ä¸­...';

            const result = await apiRequest('/verify-code', {
                method: 'POST',
                body: JSON.stringify({ code })
            });

            if (result.success) {
                showResult('verify-result', `âœ… ${result.data.message}`);
                document.getElementById('verify-code').value = '';
            } else {
                showResult('verify-result', `âŒ ${result.error}`, true);
            }

            btn.disabled = false;
            btn.innerHTML = 'éªŒè¯';
        }

        async function getStats() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>è·å–ä¸­...';

            const result = await apiRequest('/stats');

            if (result.success) {
                document.getElementById('stats-result').style.display = 'block';
                document.getElementById('stat-total').textContent = result.data.stats.total;
                document.getElementById('stat-active').textContent = result.data.stats.active;
                document.getElementById('stat-used').textContent = result.data.stats.used;
                showResult('stats-detail', result.data);
            } else {
                showResult('stats-detail', result.error, true);
            }

            btn.disabled = false;
            btn.innerHTML = 'è·å–ç»Ÿè®¡';
        }

        async function getCodeList() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>è·å–ä¸­...';

            const result = await apiRequest('/generate-codes?status=all&limit=50');

            if (result.success) {
                showResult('list-result', `å…± ${result.data.count} æ¡è®°å½•:\n\n` +
                    result.data.codes.map(c =>
                        `${c.code} | ${c.points}ç‚¹ | ${c.status} | ${new Date(c.created_at).toLocaleString()}`
                    ).join('\n'));
            } else {
                showResult('list-result', result.error, true);
            }

            btn.disabled = false;
            btn.innerHTML = 'è·å–åˆ—è¡¨';
        }

        async function exportCodes() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>å¯¼å‡ºä¸­...';

            try {
                const response = await fetch('/api/export-codes');
                if (!response.ok) throw new Error('å¯¼å‡ºå¤±è´¥');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `codes-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showResult('export-result', 'âœ… å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½');
            } catch (error) {
                showResult('export-result', `âŒ ${error.message}`, true);
            }

            btn.disabled = false;
            btn.innerHTML = 'å¯¼å‡º JSON';
        }
    </script>
</body>
</html>
